name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    name: Test Suite
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        rust: [stable]
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}
          components: rustfmt, clippy

      - name: Cache cargo registry
        uses: actions/cache@v5
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v5
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v5
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Check formatting
        run: cargo fmt -- --check

      - name: Run clippy
        run: cargo clippy -- -D warnings

      - name: Run tests
        run: cargo test --verbose

      - name: Install Elm
        run: |
          if [ "$RUNNER_OS" == "Linux" ]; then
            curl -L -o elm.gz https://github.com/elm/compiler/releases/download/0.19.1/binary-for-linux-64-bit.gz
            gunzip elm.gz
            chmod +x elm
            sudo mv elm /usr/local/bin/
          elif [ "$RUNNER_OS" == "macOS" ]; then
            curl -L -o elm.gz https://github.com/elm/compiler/releases/download/0.19.1/binary-for-mac-64-bit.gz
            gunzip elm.gz
            chmod +x elm
            sudo mv elm /usr/local/bin/
          fi
        shell: bash

      - name: Install Elm packages
        run: |
          cd e2e
          # Create a temporary Elm file that imports dependencies from elm.json.
          # Running elm make will install all packages to ~/.elm/ which the MCP
          # server needs to read package documentation offline.
          mkdir -p src
          cat > src/Main.elm << 'EOF'
          module Main exposing (main)
          import Html exposing (text)
          main = text "test"
          EOF
          elm make src/Main.elm --output=/dev/null
          rm -rf src

      - name: Run end-to-end tests
        run: |
          cd e2e
          python3 test.py

      - name: Build
        run: cargo build --verbose

  # Ensure the project builds on the minimum supported Rust version
  msrv:
    name: Minimum Supported Rust Version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust 1.82.0
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.82.0

      - name: Check MSRV
        run: cargo check --all-features
